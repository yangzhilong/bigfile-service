<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>HTML5大文件分片上传示例</title>
<script src="jquery-3.4.1.min.js"></script>
<script src="spark-md5.min.js"></script>
<script>
    var md5 = "";
    var page = {
    	md5: "",
        init: function(){
            $("#upload").click($.proxy(this.preUpload, this));
        },
        
        upload: function(file, start, end, md5) {
        	//构造一个表单，FormData是HTML5新增的
            var form = new FormData();
            form.append("file", file.slice(start,end));  //slice方法用于切出文件的一部分
            form.append("fileStart", start);
            form.append("fileEnd", end);
            form.append("sys", "cig"); 
            form.append("md5", md5); 
            
        	//Ajax提交
            $.ajax({
                url: "/v1/api/upload",
                dataType: "json",
                type: "POST",
                data: form,
                async: true,        //异步
                processData: false,  //很重要，告诉jquery不要对form进行处理
                contentType: false,  //很重要，指定为false才能形成正确的Content-Type
                beforeSend: function() {
                    $("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": begin upload, start is:" + start + "<br/><br/>");
                },
                success: function(data){
                    $("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": end upload, response is:" + JSON.stringify(data)+ "<br/><br/>");
                    if(data.success) {
                    	data = data.data;
                        $("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": end upload, start is" + start + ", upload ratio ：" + data.completionRatio*100 +"% <br/><br/>");
                    	
                    	if(data.s3FilePath) {
                            $("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": end upload <br/><br/>");
                            $("#url").val(data.s3FilePath);
                            return;
                        }
                    	page.upload(file, data.fileStart, data.fileEnd, md5);
                    }
                }
            });
        },
        
        preUpload: function(){
            var file = $("#file")[0].files[0],  //文件对象
                name = file.name,        //文件名
                size = file.size;        //总大小

            var jsonData = {
            		sys: "cig",
            		md5: md5,
            		fileName: name,
            		totalSize: size
                };
            $("#url").val("");
            $("#output").empty();
            
            $.ajax({
                url: "/v1/api/pre",
                type: "POST",
                dataType: "json",
                contentType : "application/json",
                data: JSON.stringify(jsonData),
                beforeSend: function() {
                	$("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": begin pre, data is:" + JSON.stringify(jsonData) + "<br/><br/>");
                },
                success: function(data) {
                	$("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": end pre, response is:" + JSON.stringify(data)+ "<br/><br/>");
                	if(data.success) {
                		data = data.data;
                		
                		var shardSize = data.sliceSize;    //分片大小
                		
                		if(data.s3FilePath) {
                			$("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": end upload <br/><br/>");
                            $("#url").val(data.s3FilePath);
                            return;
                		}
                		
                		var fileStart = data.fileStart; // 开始切片的地方
                		var fileEnd = data.fileEnd; // 结束切片的地方
                		var completionRatio = data.completionRatio; // 已完成比例
                		$("#output").prepend(dateFormat("HH:MM:SS", new Date()) + ": upload ratio ：" + completionRatio*100 +"% <br/><br/>");
                		page.upload(file, fileStart, fileEnd, md5);
                	}
                }
            });
        }
    };

    $(function(){
        page.init();
        
        var log=document.getElementById("log");
        document.getElementById("file").addEventListener("change", function() {
            var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
                file = this.files[0],
                chunkSize = 2097152, // read in chunks of 2MB
                chunks = Math.ceil(file.size / chunkSize),
                currentChunk = 0,
                spark = new SparkMD5.ArrayBuffer(),
                frOnload = function(e){
                    spark.append(e.target.result); // append array buffer
                    currentChunk++;
                    if (currentChunk < chunks)
                        loadNext();
                    else {
                        md5 = spark.end();
                    }
                },
                frOnerror = function () {
                    log.innerHTML+="\noops, something went wrong.";
                };
            function loadNext() {
                var fileReader = new FileReader();
                fileReader.onload = frOnload;
                fileReader.onerror = frOnerror;
                var start = currentChunk * chunkSize,
                    end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;
                fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
            };
            loadNext();
        });
        
        $("#download").click(function() {
        	var url = $("#url").val();
        	$("#downloadFrame").attr("src", "/v1/api/download?sys=cig&file=" + url);
        });
    });
    
    function dateFormat(fmt, date) {
        let ret;
        let opt = {
            "Y+": date.getFullYear().toString(),        // 年
            "m+": (date.getMonth() + 1).toString(),     // 月
            "d+": date.getDate().toString(),            // 日
            "H+": date.getHours().toString(),           // 时
            "M+": date.getMinutes().toString(),         // 分
            "S+": date.getSeconds().toString()          // 秒
            // 有其他格式化字符需求可以继续添加，必须转化成字符串
        };
        for (let k in opt) {
            ret = new RegExp("(" + k + ")").exec(fmt);
            if (ret) {
                fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
            };
        };
        return fmt;
    }
    </script>
</head>

<body>
    <div>
        <h2>大文件分片上传DEMO</h2>
        <h3>支持断点续传、已上传文件的秒传</h3>
        <h4><a href="md5.html" target="_blank">md5 generate demo</a></h4>
    </div>
	<input type="file" id="file" />
	<button id="upload">上传</button><br />
	<label for="url">上传的结果：</label><input name="url" id="url" readonly="readonly" style="width:400px"/><button id="download">下载</button>
	<div id="output" style="background-color: #000000; color: #FFFFFF; max-height: 500px; overflow: scroll;"></div>
	<pre id=log></pre>
	<iframe id="downloadFrame" height="0" width="0" style="border: 0"></iframe>
</body>
</html>